<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8" />
  <title>âš¾ ì‚¼ì„± í—Œí„°ìŠ¤ ì„ ìˆ˜ í¬ì§€ì…˜ âš¾</title>
  <style>
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }

    th,
    td {
      border: 1px solid #999;
      padding: 6px;
      text-align: center;
    }

    th {
      background-color: #f0f0f0;
    }

    input[type="text"],
    input[type="number"] {
      width: 5em;
    }

    select {
      width: 6em;
    }

    .controls {
      text-align: right;
      margin: 10px;
    }
  </style>
</head>

<body>
  <div style="text-align: left; margin: 10px;">
    <button onclick="goMain()">í™ˆ í™”ë©´</button>
  </div>

  <h1>âš¾ ì‚¼ì„± í—Œí„°ìŠ¤ ì„ ìˆ˜ í¬ì§€ì…˜ âš¾</h1>

  <div class="controls">
    <button onclick="saveAll()">ğŸ’¾ ì €ì¥</button>
    <button onclick="loadPlayers()">â†© ì›ë˜ëŒ€ë¡œ</button>
  </div>

  <!-- ìƒˆë¡œìš´ ì„ ìˆ˜ ì¶”ê°€ ì˜ì—­ -->
  <table>
    <thead>
      <tr>
        <th>ì´ë¦„</th>
        <th>ë°°ë²ˆ</th>
        <th>íˆ¬ìˆ˜</th>
        <th>í¬ìˆ˜</th>
        <th>1ë£¨ìˆ˜</th>
        <th>2ë£¨ìˆ˜</th>
        <th>3ë£¨ìˆ˜</th>
        <th>ìœ ê²©ìˆ˜</th>
        <th>ì™¸ì•¼ìˆ˜</th>
        <th>ì¶”ê°€</th>
      </tr>
    </thead>
    <tbody>
      <tr id="addRow">
        <td><input type="text" id="add_name" /></td>
        <td><input type="number" id="add_num" /></td>
        <td><select id="add_p"></select></td>
        <td><select id="add_c"></select></td>
        <td><select id="add_1b"></select></td>
        <td><select id="add_2b"></select></td>
        <td><select id="add_3b"></select></td>
        <td><select id="add_ss"></select></td>
        <td><select id="add_of"></select></td>
        <td><button onclick="addNewPlayer()">â• ì¶”ê°€</button></td>
      </tr>
    </tbody>
  </table>
  <!-- ê¸°ì¡´ ì„ ìˆ˜ ëª©ë¡ í…Œì´ë¸” -->
  <table id="playerTable">
    <thead>
      <tr>
        <th>ì´ë¦„ <button onclick="setSort('name')">â‡…</button></th>
        <th>ë°°ë²ˆ <button onclick="setSort('num')">â‡…</button></th>
        <th>íˆ¬ìˆ˜ <button onclick="setSort('p')">â‡…</button></th>
        <th>í¬ìˆ˜ <button onclick="setSort('c')">â‡…</button></th>
        <th>1ë£¨ìˆ˜ <button onclick="setSort('1b')">â‡…</button></th>
        <th>2ë£¨ìˆ˜ <button onclick="setSort('2b')">â‡…</button></th>
        <th>3ë£¨ìˆ˜ <button onclick="setSort('3b')">â‡…</button></th>
        <th>ìœ ê²©ìˆ˜ <button onclick="setSort('ss')">â‡…</button></th>
        <th>ì™¸ì•¼ìˆ˜ <button onclick="setSort('of')">â‡…</button></th>
        <th>ì‚­ì œ</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    const API = {
      check: "https://checkpassword-2guymqucma-uc.a.run.app",
      updatePw: "https://updatepassword-2guymqucma-uc.a.run.app",
      getPlayers: "https://getplayers-2guymqucma-uc.a.run.app",
      updatePlayers: "https://updateplayers-2guymqucma-uc.a.run.app"
    };

    const POS_FIELDS = ["p", "c", "1b", "2b", "3b", "ss", "of"];
    let currentSortField = "name";
    let currentSortOrder = "asc";

    const LABELS = {
      "0": "ğŸ”´ ë¶ˆê°€",
      "1": "ğŸŸ¡ í›„ë³´",
      "2": "ğŸŸ¢ ì„ ë°œ"
    };

    function goMain() {
      window.location.href = "index.html";
    }

    function initAddSelects() {
      POS_FIELDS.forEach(pos => {
        const sel = document.getElementById(`add_${pos}`);
        sel.innerHTML = "";
        ["0", "1", "2"].forEach(v => {
          const opt = document.createElement("option");
          opt.value = v;
          opt.textContent = LABELS[v];
          sel.appendChild(opt);
        });
        sel.value = "0";
      });
    }

    function setSort(field) {
      if (currentSortField === field) {
        currentSortOrder = currentSortOrder === "asc" ? "desc" : "asc";
      } else {
        currentSortField = field;
        currentSortOrder = "asc";
      }
      loadPlayers();
    }

    function sortData(data) {
      return data.sort((a, b) => {
        const A = a[currentSortField] ?? "";
        const B = b[currentSortField] ?? "";

        if (currentSortField === "num") {
          return currentSortOrder === "asc"
            ? Number(A || 0) - Number(B || 0)
            : Number(B || 0) - Number(A || 0);
        }

        return currentSortOrder === "asc"
          ? String(A).localeCompare(String(B), "ko")
          : String(B).localeCompare(String(A), "ko");
      });
    }

    async function verifyPassword() {
      const pw = prompt("ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”");
      if (!pw) return false;

      const res = await fetch(API.check, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ password: pw })
      });

      const result = await res.json();
      return result.status === "ì„±ê³µ";
    }

    async function loadPlayers() {
      const res = await fetch(API.getPlayers);
      let data = await res.json();
      data = sortData(data);
      renderPlayerTable(data);
    }

    function renderPlayerTable(data) {
      const tbody = document.querySelector("#playerTable tbody");
      tbody.innerHTML = "";

      data.forEach(player => {
        const tr = document.createElement("tr");

        tr.innerHTML += `<td><input type="text" value="${player.name}"></td>`;
        tr.innerHTML += `<td><input type="number" value="${player.num}"></td>`;

        POS_FIELDS.forEach(f => {
          const cur = player[f] || "0";
          let html = `<td><select>`;
          ["0", "1", "2"].forEach(v => {
            html += `<option value="${v}" ${v === cur ? "selected" : ""}>${LABELS[v]}</option>`;
          });
          html += `</select></td>`;
          tr.innerHTML += html;
        });

        tr.innerHTML += `<td><button onclick="this.parentElement.parentElement.remove()">ğŸ—‘ ì‚­ì œ</button></td>`;

        tbody.appendChild(tr);
      });
    }

    function addNewPlayer() {
      const name = document.getElementById("add_name").value.trim();
      const num = document.getElementById("add_num").value.trim();

      if (!name || !num) return alert("ì´ë¦„ê³¼ ë°°ë²ˆì€ í•„ìˆ˜ì…ë‹ˆë‹¤.");

      // ì¤‘ë³µ ì´ë¦„ ì²´í¬
      const existing = Array.from(
        document.querySelectorAll("#playerTable tbody tr td:first-child input")
      ).map(i => i.value.trim());

      if (existing.includes(name)) return alert("ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì´ë¦„ì…ë‹ˆë‹¤.");

      const tr = document.createElement("tr");

      tr.innerHTML += `<td><input type="text" value="${name}"></td>`;
      tr.innerHTML += `<td><input type="number" value="${num}"></td>`;

      POS_FIELDS.forEach(pos => {
        const v = document.getElementById(`add_${pos}`).value;
        let html = `<td><select>`;
        ["0", "1", "2"].forEach(x => {
          html += `<option value="${x}" ${x === v ? "selected" : ""}>${LABELS[x]}</option>`;
        });
        html += `</select></td>`;
        tr.innerHTML += html;
      });

      tr.innerHTML += `<td><button onclick="this.parentElement.parentElement.remove()">ğŸ—‘ ì‚­ì œ</button></td>`;

      const tbody = document.querySelector("#playerTable tbody");
      tbody.appendChild(tr);
    }

    async function saveAll() {
      const ok = await verifyPassword();
      if (!ok) return alert("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤!");

      const rows = Array.from(document.querySelectorAll("#playerTable tbody tr"));

      const players = rows.map(tr => {
        const tds = tr.querySelectorAll("td");
        return {
          name: tds[0].querySelector("input").value.trim(),
          num: tds[1].querySelector("input").value.trim(),
          p: tds[2].querySelector("select").value,
          c: tds[3].querySelector("select").value,
          "1b": tds[4].querySelector("select").value,
          "2b": tds[5].querySelector("select").value,
          "3b": tds[6].querySelector("select").value,
          ss: tds[7].querySelector("select").value,
          of: tds[8].querySelector("select").value
        };
      });

      const res = await fetch(API.updatePlayers, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(players)
      });

      const result = await res.json();
      if (result.status === "ì„±ê³µ") {
        alert("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!");
        loadPlayers();
      } else {
        alert("ì €ì¥ ì‹¤íŒ¨: " + result.error);
      }
    }

    // ì´ˆê¸° ì‹¤í–‰
    initAddSelects();
    loadPlayers();

  </script>
</body>

</html>
