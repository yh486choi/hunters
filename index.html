<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8" />

  <title>âš¾ ì‚¼ì„± í—Œí„°ìŠ¤ ì˜¤ë” ê´€ë¦¬ ì‹œìŠ¤í…œ âš¾</title>

  <link rel="stylesheet" href="common.css" />
  <link rel="stylesheet" href="index.css" />
</head>

<body>
  <h1>âš¾ ì‚¼ì„± í—Œí„°ìŠ¤ ì˜¤ë” ê´€ë¦¬ ì‹œìŠ¤í…œ âš¾</h1>
  <hr>
  <div id="mainArea" style="margin-top: 20px;">
    <div id="orderViewArea">
      <div id="viewButtons">
        <button class="buttonStyles" id="editBtn">ğŸ“ ìˆ˜ì •</button>
        <button class="buttonStyles" id="captureBtn">ğŸ“· ìº¡ì²˜</button>
        <button class="buttonStyles" onclick="copyCurrentLink()">ğŸ”— ë§í¬</button>
        <button class="buttonStyles" onclick="shareCurrentLink()">ğŸ“¤ ê³µìœ </button>
      </div>

      <div id="orderViewPanel">
        <span id="selectedOrderName">ì˜¤ë”ë¥¼ ì„ íƒí•˜ì„¸ìš”</span>

        <div id="positionWrapper">
          <div class="posBox" id="pos_P"></div>
          <div class="posBox" id="pos_C"></div>
          <div class="posBox" id="pos_1B"></div>
          <div class="posBox" id="pos_2B"></div>
          <div class="posBox" id="pos_3B"></div>
          <div class="posBox" id="pos_SS"></div>
          <div class="posBox" id="pos_LF"></div>
          <div class="posBox" id="pos_CF"></div>
          <div class="posBox" id="pos_RF"></div>
          <div class="posBox" id="pos_DH"></div>
        </div>


        <div id="orderArea">

          <!-- ì„ ë°œ -->
          <div id="startingArea">
            <span style="font-weight: bolder; text-align:center;">ì„ ë°œ ëª…ë‹¨</span>

            <table id="startingTable" class="table_common">
              <thead>
                <tr>
                  <th style="width: 30px;">íƒ€ìˆœ</th>
                  <th style="width: 80px;">ì„ ìˆ˜ëª…</th>
                  <th style="width: 100px;">í¬ì§€ì…˜</th>
                </tr>
              </thead>
              <tbody>
                <!-- íƒ€ìˆœ 1~9 -->
                <tr>
                  <td>1</td>
                  <td></td>
                  <td></td>
                </tr>
                <tr>
                  <td>2</td>
                  <td></td>
                  <td></td>
                </tr>
                <tr>
                  <td>3</td>
                  <td></td>
                  <td></td>
                </tr>
                <tr>
                  <td>4</td>
                  <td></td>
                  <td></td>
                </tr>
                <tr>
                  <td>5</td>
                  <td></td>
                  <td></td>
                </tr>
                <tr>
                  <td>6</td>
                  <td></td>
                  <td></td>
                </tr>
                <tr>
                  <td>7</td>
                  <td></td>
                  <td></td>
                </tr>
                <tr>
                  <td>8</td>
                  <td></td>
                  <td></td>
                </tr>
                <tr>
                  <td>9</td>
                  <td></td>
                  <td></td>
                </tr>
                <!-- 10ë²ˆì§¸ëŠ” íˆ¬ìˆ˜ -->
                <tr>
                  <td>íˆ¬ìˆ˜</td>
                  <td></td>
                  <td></td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- ëŒ€ê¸° -->
          <div id="waitingArea">
            <label style="font-weight: bolder;">ëŒ€ê¸° ëª…ë‹¨</label>
            <table id="waitingTable" class="table_common">
              <thead>
                <tr>
                  <th style="width: 80px;">ì„ ìˆ˜ëª…</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td></td>
                </tr>
                <tr>
                  <td></td>
                </tr>
                <tr>
                  <td></td>
                </tr>
                <tr>
                  <td></td>
                </tr>
                <tr>
                  <td></td>
                </tr>
                <tr>
                  <td></td>
                </tr>
                <tr>
                  <td></td>
                </tr>
                <tr>
                  <td></td>
                </tr>
                <tr>
                  <td></td>
                </tr>
                <tr>
                  <td></td>
                </tr>
              </tbody>

            </table>
          </div>
        </div>
      </div>
    </div>


    <div id="orderListArea">
      <div class="adminButtonBox">
        <button class="buttonStyles" onclick="location.href='order_write.html'">ğŸ“ ì˜¤ë” ì‘ì„±</button>
        <button class="buttonStyles" onclick="location.href='admin.html'">ğŸ™â€â™‚ï¸ ì„ ìˆ˜ ê´€ë¦¬</button>
        <button class="buttonStyles" onclick="changePassword()">âš™ ê´€ë¦¬ì</button>
      </div>

      <!-- ì˜¤ë” ë¦¬ìŠ¤íŠ¸ -->
      <div id="orderListBottom" style="margin-top: 10px;">
        <table id="orderTable" class="table_common">
          <thead>
            <tr>
              <th style="width: 200px; text-align: left;">ì˜¤ë”ëª…</th>
              <th style="width: 100px;">ì €ì¥ì¼ì</th>
              <th style="width: 40px;"></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <div id="pagination" style="margin-top: 10px; display: flex; gap: 5px;"></div>
      </div>
    </div>

  </div>


  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <script>
    let currentPage = 1;
    const ORDERS_PER_PAGE = 18;
    let orderList = []; // ì „ì²´ ì˜¤ë” ë¦¬ìŠ¤íŠ¸ ì €ì¥ìš©


    const API = {
      getOrders: "https://getorders-2guymqucma-uc.a.run.app",
      getOrder: "https://getorder-2guymqucma-uc.a.run.app",
      deleteOrder: "https://us-central1-hunters-f2581.cloudfunctions.net/deleteOrder",
      check: "https://checkpassword-2guymqucma-uc.a.run.app",
      updatePw: "https://updatepassword-2guymqucma-uc.a.run.app"
    };

    let currentOrderName = null;

    /* ë‚ ì§œ í¬ë§· */
    function formatDate(dateString) {
      const d = new Date(dateString);
      return `${String(d.getFullYear()).slice(2)}/${String(d.getMonth() + 1).padStart(2, "0")}/${String(d.getDate()).padStart(2, "0")} ${String(d.getHours()).padStart(2, "0")}:${String(d.getMinutes()).padStart(2, "0")}`;
    }

    /* ì´ë¦„(ë°°ë²ˆ) */
    function nameWithNum(name, players) {
      const p = players.find(x => x.name === name);
      return p ? `${name}(${p.num})` : name;
    }

    window.onload = async () => {
      loadOrderList(); // í˜ì´ì§€ê¹Œì§€ ìë™ìœ¼ë¡œ ë§ì¶°ì§
    };

    function renderPagination() {
      const container = document.getElementById("pagination");
      container.innerHTML = "";

      const totalPages = Math.ceil(orderList.length / ORDERS_PER_PAGE);
      for (let i = 1; i <= totalPages; i++) {
        const btn = document.createElement("button");
        btn.textContent = i;
        btn.className = "buttonStyles";
        if (i === currentPage) {
          btn.style.background = "#ffd966"; // ì„ íƒëœ í˜ì´ì§€ ê°•ì¡°
        }
        btn.onclick = () => renderOrderPage(i);
        container.appendChild(btn);
      }
    }

    /* ë¦¬ìŠ¤íŠ¸ ë¡œë”© */
    function renderOrderPage(page) {
      currentPage = page;

      const tbody = document.querySelector("#orderTable tbody");
      tbody.innerHTML = "";

      const start = (page - 1) * ORDERS_PER_PAGE;
      const end = start + ORDERS_PER_PAGE;
      const pageOrders = orderList.slice(start, end);

      pageOrders.forEach(item => {
        const tr = document.createElement("tr");

        // âœ… í˜„ì¬ ì„ íƒëœ ì˜¤ë”ëª…ê³¼ ê°™ìœ¼ë©´ ê°•ì¡°
        if (item.orderName === currentOrderName) {
          tr.classList.add("selected-order-row");
        }

        const nameTd = document.createElement("td");
        nameTd.innerHTML = `<span class="order-link">${item.orderName}</span>`;
        nameTd.onclick = () => loadOrderView(item.orderName);
        nameTd.style.textAlign = "left";

        const dateTd = document.createElement("td");
        dateTd.textContent = formatDate(item.savedAt);

        const delTd = document.createElement("td");
        const delBtn = document.createElement("button");
        delBtn.textContent = "ì‚­ì œ";
        delBtn.className = "buttonStyles";
        delBtn.onclick = () => deleteOrderWithPW(item.orderName);
        delTd.appendChild(delBtn);

        tr.appendChild(nameTd);
        tr.appendChild(dateTd);
        tr.appendChild(delTd);
        tbody.appendChild(tr);
      });


      renderPagination();
    }




    /* ìƒì„¸ ë³´ê¸° */
    async function loadOrderView(name) {


      // URL ì—…ë°ì´íŠ¸
      window.history.replaceState(null, "", "?orderName=" + encodeURIComponent(name));

      const data = await fetch(API.getOrder + "?name=" + encodeURIComponent(name))
        .then(r => r.json());

      if (!data || !data.payload) {
        alert("ì˜¤ë” ë°ì´í„°ê°€ ì†ìƒë˜ì—ˆê±°ë‚˜ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
        return;
      }
      currentOrderName = name;

      // ê°•ì¡°: ê¸°ì¡´ ê°•ì¡° ì œê±° í›„, í˜„ì¬ ì„ íƒ í–‰ ê°•ì¡°
      document.querySelectorAll("#orderTable tbody tr").forEach(tr => {
        tr.classList.remove("selected-order-row");
      });

      const rows = Array.from(document.querySelectorAll("#orderTable tbody tr"));
      const match = rows.find(tr => {
        const nameCell = tr.querySelector("td:first-child");
        return nameCell && nameCell.textContent.trim() === name;
      });

      if (match) {
        match.classList.add("selected-order-row");
      }


      document.getElementById("selectedOrderName").textContent = name;

      const payload = data.payload;
      window._currentPlayers = payload.players;
      renderPositions(payload.positions);
      renderStarting(payload.startingList, payload.players);
      renderWaiting(payload.players, payload.startingList);
    }

    /* í¬ì§€ì…˜ ì¶œë ¥ */
    function renderPositions(pos) {
      ["P", "C", "1B", "2B", "3B", "SS", "LF", "CF", "RF", "DH"].forEach(key => {
        const box = document.getElementById("pos_" + key);
        const name = pos[key];
        box.textContent = name ? nameWithNum(name, window._currentPlayers) : "";

      });
    }

    /* ì„ ë°œ */
    function renderStarting(list, players) {
      const rows = document.querySelectorAll("#startingTable tbody tr");

      for (let i = 0; i < 10; i++) {
        const row = rows[i];
        const item = list[i];
        const cells = row.querySelectorAll("td");

        if (item) {
          const orderLabel = i === 9 ? "íˆ¬ìˆ˜" : (i + 1);
          cells[0].textContent = orderLabel;
          cells[1].textContent = item.name ? nameWithNum(item.name, players) : "";
          cells[2].textContent = item.pos || "";
        } else {
          cells[1].textContent = "";
          cells[2].textContent = "";
        }
      }
    }


    /* ëŒ€ê¸° ëª…ë‹¨ */
    function renderWaiting(players, startingList) {
      const tbody = document.querySelector("#waitingTable tbody");
      const rows = Array.from(tbody.querySelectorAll("tr"));

      const usedNames = startingList.map(s => s.name).filter(Boolean);
      const waitingNames = players
        .map(p => p.name)
        .filter(n => !usedNames.includes(n));

      // âœ… 1. 10í–‰ ì´í›„ëŠ” ì œê±°
      while (rows.length > 10) {
        const lastRow = rows.pop();
        lastRow.remove();
      }

      // âœ… 2. ê¸°ë³¸ 10í–‰ ì±„ìš°ê¸°
      for (let i = 0; i < 10; i++) {
        const row = rows[i];
        const cell = row.querySelector("td");
        cell.textContent = waitingNames[i] ? nameWithNum(waitingNames[i], players) : "";
      }

      // âœ… 3. 10ê°œ ì´ˆê³¼ ì‹œ ì¶”ê°€ í–‰ ìƒì„±
      for (let i = 10; i < waitingNames.length; i++) {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${nameWithNum(waitingNames[i], players)}</td>`;
        tbody.appendChild(tr);
      }
    }



    /* ìˆ˜ì • */
    document.getElementById("editBtn").onclick = () => {
      if (!currentOrderName) return alert("ì˜¤ë”ë¥¼ ì„ íƒí•˜ì„¸ìš”");
      location.href = "order_write.html?orderName=" + encodeURIComponent(currentOrderName);
    };

    async function loadOrderList() {
      orderList = await fetch(API.getOrders).then(r => r.json());

      // ìµœì‹ ìˆœ ì •ë ¬
      orderList.sort((a, b) => new Date(b.savedAt) - new Date(a.savedAt));

      const params = new URLSearchParams(location.search);
      const orderName = params.get("orderName");

      if (orderName) {
        const index = orderList.findIndex(o => o.orderName === orderName);
        if (index !== -1) {
          currentOrderName = orderName; // âœ… ë¨¼ì € í˜„ì¬ ì„ íƒ ì˜¤ë” ì €ì¥
          const page = Math.floor(index / ORDERS_PER_PAGE) + 1;
          renderOrderPage(page);        // âœ… ê·¸ ë‹¤ìŒ í…Œì´ë¸” ë Œë”ë§ (ê°•ì¡° ì ìš©ë¨)
          await loadOrderView(orderName); // âœ… ì´í›„ ìƒì„¸ ë‚´ìš© í‘œì‹œ
        } else {
          renderOrderPage(1);
        }
      } else {
        renderOrderPage(1);
      }


    }


    /* ì‚­ì œ */
    async function deleteOrderWithPW(name) {
      const pw = prompt("ì‚­ì œ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥");
      if (!pw) return;

      const valid = await fetch(API.check, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ password: pw })
      }).then(r => r.json());

      if (valid.status !== "ì„±ê³µ") return alert("ë¹„ë°€ë²ˆí˜¸ ì˜¤ë¥˜!");

      const res = await fetch(API.deleteOrder + "?name=" + encodeURIComponent(name))
        .then(r => r.json());

      if (res.status === "deleted") {
        alert("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
      } else {
        alert("ì‚­ì œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ.");
      }

      location.reload();
    }

    /* ìº¡ì²˜ */
    document.getElementById("captureBtn").onclick = async () => {
      const target = document.getElementById("orderViewPanel");
      if (!target) return alert("ìº¡ì²˜ ëŒ€ìƒì´ ì—†ìŠµë‹ˆë‹¤.");

      document.body.style.overflow = "hidden";

      try {
        const canvas = await html2canvas(target, {
          scale: 2,
          useCORS: true
        });

        // âœ… JPG í¬ë§·ìœ¼ë¡œ ì´ë¯¸ì§€ ìƒì„±
        const image = canvas.toDataURL("image/jpeg", 0.92); // 92% í€„ë¦¬í‹°

        // âœ… ìº¡ì²˜ ì‹œê° â†’ yymmddhhmmss í˜•ì‹
        const now = new Date();
        const pad = (n) => n.toString().padStart(2, "0");
        const timestamp1 =
          pad(now.getFullYear() % 100) +
          pad(now.getMonth() + 1) +
          pad(now.getDate());
        const timestamp2 =
          pad(now.getHours()) +
          pad(now.getMinutes()) +
          pad(now.getSeconds());

        // âœ… íŒŒì¼ëª…: order_ì˜¤ë”ëª…_ì‹œê°.jpg
        const fileName = `order_${currentOrderName}_${timestamp1}_${timestamp2}.jpg`;

        // ë‹¤ìš´ë¡œë“œ ì²˜ë¦¬
        const link = document.createElement("a");
        link.href = image;
        link.download = fileName;
        link.click();

      } catch (err) {
        alert("ìº¡ì²˜ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: " + err.message);
      } finally {
        document.body.style.overflow = "auto";
      }
    };



    /* ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ */
    async function changePassword() {
      const oldPw = prompt("í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥");
      if (!oldPw) return;

      const checkRes = await fetch(API.check, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ password: oldPw })
      }).then(r => r.json());

      if (checkRes.status !== "ì„±ê³µ") {
        alert("ë¹„ë°€ë²ˆí˜¸ ì˜¤ë¥˜");
        return;
      }

      const newPw = prompt("ìƒˆ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥");
      if (!newPw) return;

      const upd = await fetch(API.updatePw, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ oldPassword: oldPw, newPassword: newPw })
      }).then(r => r.json());

      if (upd.status === "ì„±ê³µ") alert("ë³€ê²½ ì™„ë£Œ!");
      else alert("ë³€ê²½ ì‹¤íŒ¨: " + upd.error);
    }

    function shareCurrentLink() {
      const url = window.location.href;

      if (navigator.share) {
        navigator.share({
          title: document.title,
          url: url
        });
      } else {
        // ì§€ì› ì•ˆ ë˜ëŠ” í™˜ê²½ â†’ ë³µì‚¬ë¡œ ëŒ€ì²´
        navigator.clipboard.writeText(url);
        alert("ê³µìœ  ê¸°ëŠ¥ì´ ì—†ì–´ ë§í¬ë¥¼ ë³µì‚¬í–ˆìŠµë‹ˆë‹¤.");
      }
    }

    function copyCurrentLink() {
      const url = window.location.href;

      navigator.clipboard.writeText(url)
        .then(() => {
          alert("í˜„ì¬ ë§í¬ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.");
        })
        .catch(() => {
          alert("í´ë¦½ë³´ë“œ ë³µì‚¬ ì‹¤íŒ¨");
        });
    }



  </script>

</body>

</html>