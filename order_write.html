<!DOCTYPE html>
<html lang='ko'>

<head>
  <meta charset='UTF-8' />
  <meta name='viewport' content='width=device-width, initial-scale=1.0' />
  <title>오더 작성</title>

  <link rel="stylesheet" href="common.css" />
  <link rel="stylesheet" href="order_write.css" />
</head>

<body>

  <h1>오더 작성</h1>

  <div style='margin-top:10px; display:flex; gap:10px;'>
    <button class='buttonStyles' onclick="location.href='index.html'">홈 화면</button>
    <button class='buttonStyles'>불러오기</button>
    <button class='buttonStyles' onclick='saveOrder()'>저장</button>
  </div>

  <div style='margin-top:10px;'>
    <label>오더명: </label>
    <input type='text' id='orderName' placeholder='ex) 26-03-01 NBL' style='width:260px; padding:6px;' />
  </div>

  <div id='mainArea'>

    <!-- 참가 명단 -->
    <div id='areaA' class='panelBox'>
      <label style="font-weight: bolder;">참가 명단</label>

      <div style='display:flex; gap:10px; align-items:center; margin-bottom:10px;'>
        <select id='playerSelect'></select>
        <button class='buttonStyles' onclick='addPlayer()'>추가</button>
      </div>

      <table class="table_common">
        <thead>
          <tr>
            <th style="width: 80px;">선수명</th>
            <th style="width: 40px;">삭제</th>
          </tr>
        </thead>
        <tbody id='playerTableBody'></tbody>
      </table>
    </div>

    <!-- 중앙 필드 + 선발 -->
    <div id='positionWrapper'>

      <div id='areaB1'>
        <select id='pos_CF' class='posSelect' onchange='updatePosition("CF", this.value)'></select>
        <select id='pos_LF' class='posSelect' onchange='updatePosition("LF", this.value)'></select>
        <select id='pos_RF' class='posSelect' onchange='updatePosition("RF", this.value)'></select>

        <select id='pos_SS' class='posSelect' onchange='updatePosition("SS", this.value)'></select>
        <select id='pos_2B' class='posSelect' onchange='updatePosition("2B", this.value)'></select>
        <select id='pos_3B' class='posSelect' onchange='updatePosition("3B", this.value)'></select>
        <select id='pos_1B' class='posSelect' onchange='updatePosition("1B", this.value)'></select>

        <select id='pos_P' class='posSelect' onchange='updatePosition("P", this.value)'></select>
        <select id='pos_C' class='posSelect' onchange='updatePosition("C", this.value)'></select>
        <select id='pos_DH' class='posSelect' onchange='updatePosition("DH", this.value)'></select>
      </div>

      <div id='middleWrapper'>

        <div id='areaC1'>
          <table class="table_common">
            <caption style='font-weight:bolder;'>선발 명단</caption>
            <thead>
              <tr>
                <th style="width: 40px;">타순</th>
                <th style="width: 80px;">선수명</th>
                <th style="width: 100px;">포지션</th>
              </tr>
            </thead>
            <tbody id='startingTableBody'></tbody>
          </table>
        </div>

        <div id='areaC2'>
          <table class="table_common">
            <caption style='font-weight:bolder;'>대기 명단</caption>
            <thead>
              <tr>
                <th style="width: 80px;">선수명</th>
              </tr>
            </thead>
            <tbody id='waitingTableBody'></tbody>
          </table>
        </div>

      </div>

    </div>

    <!-- 출전 가능 포지션 -->
    <div id='areaB2'>
      <div id='positionAbilityContainer'></div>
    </div>

  </div>

  <script>
    const API = { getPlayers: 'https://getplayers-2guymqucma-uc.a.run.app' };

    let playerDB = [];
    let selectedPlayers = [];

    let positionAssignments = {
      CF: '', LF: '', RF: '',
      SS: '', '2B': '', '3B': '',
      P: '', C: '', DH: '', '1B': ''
    };

    let startingList = Array(10).fill('').map(() => ({ name: '', num: '', pos: '' }));

    const abilityPositions = [
      { key: 'p', label: '투수' }, { key: 'c', label: '포수' },
      { key: '1b', label: '1루' }, { key: '2b', label: '2루' },
      { key: '3b', label: '3루' }, { key: 'ss', label: '유격' },
      { key: 'of', label: '외야' }
    ];

    window.onload = async () => {
      await loadPlayerDB();
      setupStartingTable();
      renderPlayerSelect();
      renderPlayerTable();
      renderPositionSelects();
      renderStartingTable();
      renderWaitingTable();
      renderPositionAbility();
    };

    async function loadPlayerDB() {
      const res = await fetch(API.getPlayers);
      playerDB = await res.json();
    }

    /* =============== 글로벌 유틸 =============== */
    function nameWithNum(name) {
      const p = playerDB.find(x => x.name === name);
      return p ? `${name}(${p.num})` : name;
    }

    /* =============== 참가 명단 =============== */
    function renderPlayerSelect() {
      const select = document.getElementById('playerSelect');
      select.innerHTML = '';

      const candidates = playerDB.filter(p => !selectedPlayers.includes(p.name));

      if (candidates.length === 0) {
        const opt = document.createElement('option');
        opt.textContent = '추가 없음';
        opt.disabled = true;
        select.appendChild(opt);
        return;
      }

      candidates.forEach(p => {
        const opt = document.createElement('option');
        opt.value = p.name;
        opt.textContent = `${p.name}(${p.num})`;
        select.appendChild(opt);
      });
    }

    function renderPlayerTable() {
      const tbody = document.getElementById('playerTableBody');
      tbody.innerHTML = '';

      selectedPlayers
        .sort((a, b) => a.localeCompare(b, 'ko'))
        .forEach(name => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
        <td>${nameWithNum(name)}</td>
        <td><button class='buttonStyles' onclick='removePlayer("${name}")'>삭제</button></td>
      `;
          tbody.appendChild(tr);
        });
    }

    function addPlayer() {
      const name = document.getElementById('playerSelect').value;
      if (!name) return;

      selectedPlayers.push(name);

      renderPlayerSelect();
      renderPlayerTable();
      renderPositionSelects();
      renderStartingTable();
      renderWaitingTable();
      renderPositionAbility();
    }

    function removePlayer(name) {
      selectedPlayers = selectedPlayers.filter(n => n !== name);

      for (const pos in positionAssignments) {
        if (positionAssignments[pos] === name) {
          positionAssignments[pos] = '';
        }
      }

      startingList.forEach((row, i) => {
        if (row.name === name) {
          startingList[i] = { name: '', num: '', pos: '' };
        }
      });

      renderPlayerSelect();
      renderPlayerTable();
      renderPositionSelects();
      renderStartingTable();
      renderWaitingTable();
      renderPositionAbility();
    }

    /* =============== 포지션 Select =============== */
    function renderPositionSelects() {
      const selects = document.querySelectorAll('.posSelect');

      selects.forEach(sel => {
        const pos = sel.id.replace('pos_', '');
        sel.innerHTML = '';

        const blank = document.createElement('option');
        blank.value = '';
        blank.textContent = ' ';
        sel.appendChild(blank);

        selectedPlayers.forEach(name => {
          const p = playerDB.find(x => x.name === name);
          const opt = document.createElement('option');
          opt.value = name;
          opt.textContent = `${name}(${p.num})`;
          if (positionAssignments[pos] === name) opt.selected = true;
          sel.appendChild(opt);
        });
      });
    }

    function updatePosition(pos, playerName) {
      for (const key in positionAssignments) {
        if (positionAssignments[key] === playerName) {
          positionAssignments[key] = '';
        }
      }

      positionAssignments[pos] = playerName;

      startingList.forEach((row, i) => {
        if (!row.name) return;
        const stillAssigned = Object.values(positionAssignments).includes(row.name);
        if (!stillAssigned) {
          startingList[i] = { name: '', num: '', pos: '' };
        }
      });

      startingList.forEach((row, i) => {
        if (!row.name) return;

        const posCode = Object.keys(positionAssignments)
          .find(key => positionAssignments[key] === row.name);

        if (posCode) {
          const p = playerDB.find(x => x.name === row.name);
          row.pos = convertPosition(posCode);
          row.num = p.num;
        }
      });

      renderPositionSelects();
      renderStartingTable();
      renderWaitingTable();
      renderPositionAbility();
    }

    /* =============== 선발 테이블 =============== */
    function setupStartingTable() {
      const tbody = document.getElementById('startingTableBody');
      tbody.innerHTML = '';

      for (let i = 0; i < 10; i++) {
        const orderLabel = (i < 9) ? (i + 1) : '투수';

        const tr = document.createElement('tr');
        tr.innerHTML = `
      <td>${orderLabel}</td>
      <td>
        ${i === 9
            ? `<span id='start_name_${i}'></span>`
            : `<select id='start_sel_${i}' style='width:90px;' onchange='selectStarting(${i}, this.value)'></select>`
          }
      </td>
      <td id='start_pos_${i}'></td>
    `;

        tbody.appendChild(tr);
      }
    }

    function renderStartingTable() {
      const candidates = Object.values(positionAssignments).filter(v => v !== '');

      for (let i = 0; i < 10; i++) {

        if (i === 9) {
          const name = positionAssignments['P'];
          const span = document.getElementById('start_name_' + i);

          if (name) {
            span.textContent = nameWithNum(name);
            startingList[i] = {
              name,
              num: playerDB.find(x => x.name === name).num,
              pos: convertPosition('P')
            };
            document.getElementById('start_pos_' + i).textContent = startingList[i].pos;
          } else {
            span.textContent = '';
            document.getElementById('start_pos_' + i).textContent = '';
            startingList[i] = { name: '', num: '', pos: '' };
          }

          continue;
        }

        const sel = document.getElementById('start_sel_' + i);
        sel.innerHTML = '';

        const blank = document.createElement('option');
        blank.value = '';
        blank.textContent = ' ';
        sel.appendChild(blank);

        candidates.forEach(name => {
          const p = playerDB.find(x => x.name === name);
          const opt = document.createElement('option');
          opt.value = name;
          opt.textContent = `${name}(${p.num})`;
          if (startingList[i].name === name) opt.selected = true;
          sel.appendChild(opt);
        });

        const row = startingList[i];
        document.getElementById('start_pos_' + i).textContent = row.pos || '';
      }
    }

    function selectStarting(idx, playerName) {
      startingList.forEach((row, i) => {
        if (i !== idx && row.name === playerName) {
          startingList[i] = { name: '', num: '', pos: '' };
        }
      });

      if (!playerName) {
        startingList[idx] = { name: '', num: '', pos: '' };
      } else {
        const p = playerDB.find(x => x.name === playerName);
        const posCode = Object.keys(positionAssignments)
          .find(key => positionAssignments[key] === playerName);

        startingList[idx] = {
          name: playerName,
          num: p.num,
          pos: convertPosition(posCode)
        };
      }

      renderStartingTable();
      renderWaitingTable();
      renderPositionAbility();
    }

    /* =============== 대기 명단 =============== */
    function renderWaitingTable() {
      const tbody = document.getElementById('waitingTableBody');
      tbody.innerHTML = '';

      const starters = startingList.map(r => r.name).filter(v => v);

      selectedPlayers
        .filter(name => !starters.includes(name))
        .sort((a, b) => a.localeCompare(b, 'ko'))
        .forEach(name => {
          const tr = document.createElement('tr');

          const info = playerDB.find(x => x.name === name);

          tr.innerHTML = `<td>${nameWithNum(name)}</td>`;

          if (Object.values(positionAssignments).includes(name))
            tr.classList.add('warningRow');

          tbody.appendChild(tr);
        });
    }

    /* =============== 출전 가능 포지션 =============== */
    function renderPositionAbility() {
      const container = document.getElementById('positionAbilityContainer');
      container.innerHTML = '';

      const table = document.createElement('table');
      table.classList.add("table_common");

      const players = selectedPlayers.slice().sort((a, b) => a.localeCompare(b, 'ko'));

      abilityPositions.forEach(pos => {
        const starters = [];
        const backups = [];

        players.forEach(name => {
          const p = playerDB.find(x => x.name === name);
          const v = Number(p[pos.key]);
          if (v === 2) starters.push(name);
          else if (v === 1) backups.push(name);
        });

        const trStarter = document.createElement('tr');

        const tdPos = document.createElement('td');
        tdPos.textContent = pos.label;
        tdPos.rowSpan = 2;
        tdPos.style.background = '#bae4ff';
        tdPos.style.fontWeight = 'bolder';
        trStarter.appendChild(tdPos);

        const tdStarterLabel = document.createElement('td');
        tdStarterLabel.textContent = '선발';
        tdStarterLabel.style.background = '#bae4ff';
        tdStarterLabel.style.fontWeight = 'bolder';
        trStarter.appendChild(tdStarterLabel);

        starters.forEach(name => {
          const td = document.createElement('td');
          td.textContent = nameWithNum(name);
          td.style.cursor = 'pointer';
          td.onclick = () => onAbilityClick(name, pos.key);
          const assigned = Object.keys(positionAssignments).find(k => positionAssignments[k] === name);
          if (assigned) {
            if (isSamePosition(pos.key, assigned.toLowerCase())) td.classList.add('position-selected');
            else td.classList.add('position-locked');
          }
          trStarter.appendChild(td);
        });

        table.appendChild(trStarter);

        const trBackup = document.createElement('tr');

        const tdBackupLabel = document.createElement('td');
        tdBackupLabel.textContent = '후보';
        tdBackupLabel.style.background = '#ffbbbb';
        tdBackupLabel.style.fontWeight = 'bolder';
        trBackup.appendChild(tdBackupLabel);

        backups.forEach(name => {
          const td = document.createElement('td');
          td.textContent = nameWithNum(name);
          td.style.cursor = 'pointer';
          td.onclick = () => onAbilityClick(name, pos.key);
          const assigned = Object.keys(positionAssignments).find(k => positionAssignments[k] === name);
          if (assigned) {
            if (isSamePosition(pos.key, assigned.toLowerCase())) td.classList.add('position-selected');
            else td.classList.add('position-locked');
          }
          trBackup.appendChild(td);
        });

        table.appendChild(trBackup);
      });

      container.appendChild(table);
    }

    function isSamePosition(posKey, assignedPos) {
      if (!assignedPos) return false;
      if (posKey === 'of')
        return ['cf', 'lf', 'rf'].includes(assignedPos);
      return posKey === assignedPos;
    }

    function convertPosition(code) {
      const map = {
        CF: '중견수(CF)', LF: '좌익수(LF)', RF: '우익수(RF)',
        SS: '유격수(SS)', '2B': '2루수(2B)', '3B': '3루수(3B)',
        '1B': '1루수(1B)', P: '투수(P)', C: '포수(C)', DH: '지명타자(DH)'
      };
      return map[code] || '';
    }

    function saveOrder() {
      const name = document.getElementById('orderName').value.trim();
      if (!name) return alert('오더명을 입력해주세요.');

      const payload = {
        orderName: name,
        players: [...selectedPlayers],
        positions: { ...positionAssignments },
        startingList: [...startingList]
      };

      console.log(payload);
      alert('저장 기능은 추후 구현됩니다!');
    }

    let pendingOutfieldPlayer = null;

    function onAbilityClick(playerName, posKey) {
      const posMap = {
        p: 'P',
        c: 'C',
        '1b': '1B',
        '2b': '2B',
        '3b': '3B',
        ss: 'SS',
        of: null
      };

      if (posKey === 'of') {
        pendingOutfieldPlayer = playerName;
        document.getElementById("outfieldPopup").style.display = "block";
        return;
      }

      const posCode = posMap[posKey];
      updatePosition(posCode, playerName);
      refreshAll();
    }

    function selectOutfieldPosition(posCode) {
      if (!pendingOutfieldPlayer) return;

      updatePosition(posCode, pendingOutfieldPlayer);

      pendingOutfieldPlayer = null;
      closeOutfieldPopup();
      refreshAll();
    }

    function closeOutfieldPopup() {
      document.getElementById("outfieldPopup").style.display = "none";
    }

    function refreshAll() {
      renderPositionSelects();
      renderStartingTable();
      renderWaitingTable();
      renderPositionAbility();
    }

  </script>

</body>

</html>

<!-- 외야 포지션 선택 팝업 -->
<div id="outfieldPopup" style="
       display:none;
       position:fixed;
       top:50%;
       left:50%;
       transform:translate(-50%, -50%);
       background:white;
       border:2px solid #333;
       padding:20px;
       border-radius:10px;
       z-index:1000;
       text-align:center;
     ">
  <h3>외야 포지션 선택</h3>
  <button class="buttonStyles" onclick="selectOutfieldPosition('LF')">좌익수(LF)</button>
  <button class="buttonStyles" onclick="selectOutfieldPosition('CF')">중견수(CF)</button>
  <button class="buttonStyles" onclick="selectOutfieldPosition('RF')">우익수(RF)</button>
  <br><br>
  <button class="buttonStyles" onclick="closeOutfieldPopup()">취소</button>
</div>