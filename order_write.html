<!DOCTYPE html>
<html lang='ko'>

<head>
  <meta charset='UTF-8' />
  <meta name='viewport' content='width=device-width, initial-scale=1.0' />
  <title>오더 작성</title>

  <style>
    body {
      font-size: 16px;
      font-family: Arial, sans-serif;
      padding: 20px;
    }

    .buttonStyles {
      padding: 6px 10px;
      font-size: 14px;
      border-radius: 8px;
      background: #ffffff;
      border: 1px solid #9f9f9f;
      cursor: pointer;
      transition: 0.15s ease;
      user-select: none;
    }
    .buttonStyles:hover { background: #f2f2f2; }
    .buttonStyles:active { background: #e2e2e2; transform: scale(0.98); }

    /* 3단 레이아웃: 참가명단 | 중앙묶음 | 출전 가능 포지션 */
    #mainArea {
      display: flex;
      gap: 20px;
      align-items: flex-start;
      margin-top: 20px;
    }

    /* 왼쪽 패널, 오른쪽 패널 */
    .panelBox {
      width: 180px;
      border: 1px solid #aaa;
      border-radius: 8px;
      padding: 10px;
      flex-shrink: 0;
    }

    /* 중앙 묶음: 포지션 지정 + 선발/대기 */
    #positionWrapper {
      width: 500px;
      border: 1px solid #000000;
      border-radius: 10px;
      padding: 15px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    /* 포지션 지정 영역 */
    #areaB1 {
      width: 500px;
      height:400px;
      background-image: url('field.png');
      background-size: cover;
      background-repeat: no-repeat;
      border: 1px solid #ccc;
      border-radius: 8px;
      position: relative;
    }

    .posSelect {
      position: absolute;
      width: 70px;
      padding: 3px;
      font-size: 14px;
      border-radius: 8px;
    }

    /* 포지션 좌표 */
    #pos_CF { top:15%; left:50%; transform:translateX(-50%); }
    #pos_LF { top:25%; left:18%; }
    #pos_RF { top:25%; right:18%; }
    #pos_SS { top:47%; left:30%; }
    #pos_2B { top:47%; right:30%; }
    #pos_3B { top:63%; left:20%; }
    #pos_1B { top:63%; right:20%; }
    #pos_P  { top:63%; left:50%; transform:translateX(-50%); }
    #pos_C  { top:80%; left:50%; transform:translateX(-50%); }
    #pos_DH { top:85%; right:13%; }

    /* 중앙 묶음 하단: 선발 + 대기 */
    #middleWrapper {
      display: flex;
      gap: 10px;
    }

    #areaC1, #areaC2 {
      border: 1px solid #aaa;
      border-radius: 8px;
      padding: 10px;
    }

    /* 오른쪽: 출전 가능 포지션 리스트 */
    #areaB2 {
      flex-shrink: 0;
    }

    #positionAbilityContainer {
      display: flex;
      gap: 12px;
    }

    table {
      border-collapse: collapse;
      margin-top: 8px;
      height: max-content;
    }

    th, td {
      border: 1px solid #999;
      padding: 6px;
      text-align: center;
      height: 10px;
    }

    th { background: #bae4ff; }

    .warningRow { background: #fff7a0 !important; }
    .position-selected { background: #fff7a0 !important; }
    .position-locked { background: #e2e2e2 !important; }
  </style>
</head>

<body>

  <h1>오더 작성</h1>

  <div style='margin-top:10px; display:flex; gap:10px;'>
    <button class='buttonStyles'>불러오기(개발예정)</button>
    <button class='buttonStyles' onclick='saveOrder()'>저장(개발예정)</button>
  </div>

  <div style='margin-top:10px;'>
    <label>오더명: </label>
    <input type='text' id='orderName' placeholder='예: 4월 28일 LG전' style='width:260px; padding:6px;' />
  </div>

  <!-- 3단 레이아웃 시작 -->
  <div id='mainArea'>

    <!-- 좌측: 참가 명단 -->
    <div id='areaA' class='panelBox'>
      <label style="font-weight: bolder;">참가 명단</label>

      <div style='display:flex; gap:10px; align-items:center; margin-bottom:10px;'>
        <select id='playerSelect'></select>
        <button class='buttonStyles' onclick='addPlayer()'>추가</button>
      </div>

      <table>
        <thead>
          <tr>
            <th>선수명</th>
            <th>배번</th>
            <th>삭제</th>
          </tr>
        </thead>
        <tbody id='playerTableBody'></tbody>
      </table>
    </div>

    <!-- 중앙 묶음 -->
    <div id='positionWrapper'>

      <!-- 상단: 포지션 지정 -->
      <div id='areaB1'>
        <select id='pos_CF' class='posSelect' onchange='updatePosition("CF", this.value)'></select>
        <select id='pos_LF' class='posSelect' onchange='updatePosition("LF", this.value)'></select>
        <select id='pos_RF' class='posSelect' onchange='updatePosition("RF", this.value)'></select>

        <select id='pos_SS' class='posSelect' onchange='updatePosition("SS", this.value)'></select>
        <select id='pos_2B' class='posSelect' onchange='updatePosition("2B", this.value)'></select>
        <select id='pos_3B' class='posSelect' onchange='updatePosition("3B", this.value)'></select>
        <select id='pos_1B' class='posSelect' onchange='updatePosition("1B", this.value)'></select>

        <select id='pos_P' class='posSelect' onchange='updatePosition("P", this.value)'></select>
        <select id='pos_C' class='posSelect' onchange='updatePosition("C", this.value)'></select>
        <select id='pos_DH' class='posSelect' onchange='updatePosition("DH", this.value)'></select>
      </div>

      <!-- 하단: 선발 + 대기 -->
      <div id='middleWrapper'>

        <div id='areaC1'>
          <table>
            <caption style='font-weight:bolder;'>선발 명단</caption>
            <thead>
              <tr>
                <th style='width:50px;'>타순</th>
                <th>선수명</th>
                <th style='width:50px;'>배번</th>
                <th style='width:100px;'>포지션</th>
              </tr>
            </thead>
            <tbody id='startingTableBody'></tbody>
          </table>
        </div>

        <div id='areaC2'>
          <table>
            <caption style='font-weight:bolder;'>대기 명단</caption>
            <thead>
              <tr>
                <th style='width:60px;'>선수명</th>
                <th style='width:35px;'>배번</th>
              </tr>
            </thead>
            <tbody id='waitingTableBody'></tbody>
          </table>
        </div>

      </div>

    </div>

    <!-- 우측: 출전 가능 포지션 리스트 -->
    <div id='areaB2'>
      <div id='positionAbilityContainer'></div>
    </div>

  </div>

  <!-- ========================= JS (원본 유지, 추가 변경 없음) ========================= -->
  <script>
    const API = {
      getPlayers: 'https://getplayers-2guymqucma-uc.a.run.app'
    };

    let playerDB = [];
    let selectedPlayers = [];

    let positionAssignments = {
      CF: '', LF: '', RF: '',
      SS: '', '2B': '', '3B': '',
      P: '', C: '', DH: '', '1B': ''
    };

    let startingList = Array(10).fill('').map(() => ({
      name: '',
      num: '',
      pos: ''
    }));

    const abilityPositions = [
      { key: 'p', label: '투수' },
      { key: 'c', label: '포수' },
      { key: '1b', label: '1루' },
      { key: '2b', label: '2루' },
      { key: '3b', label: '3루' },
      { key: 'ss', label: '유격' },
      { key: 'of', label: '외야' }
    ];

    window.onload = async () => {
      await loadPlayerDB();
      setupStartingTable();
      renderPlayerSelect();
      renderPlayerTable();
      renderPositionSelects();
      renderStartingTable();
      renderWaitingTable();
      renderPositionAbility();
    };

    async function loadPlayerDB() {
      const res = await fetch(API.getPlayers);
      playerDB = await res.json();
    }

    function renderPlayerSelect() {
      const select = document.getElementById('playerSelect');
      select.innerHTML = '';

      const candidates = playerDB.filter(p => !selectedPlayers.includes(p.name));

      if (candidates.length === 0) {
        const opt = document.createElement('option');
        opt.textContent = '추가 없음';
        opt.disabled = true;
        select.appendChild(opt);
        return;
      }

      candidates.forEach(p => {
        const opt = document.createElement('option');
        opt.value = p.name;
        opt.textContent = p.name + ' (' + p.num + ')';
        select.appendChild(opt);
      });
    }

    function renderPlayerTable() {
      const tbody = document.getElementById('playerTableBody');
      tbody.innerHTML = '';

      selectedPlayers.sort((a, b) => a.localeCompare(b, 'ko'));

      selectedPlayers.forEach(name => {
        const info = playerDB.find(x => x.name === name);

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${name}</td>
          <td>${info.num}</td>
          <td>
            <button class='buttonStyles' onclick='removePlayer("${name}")'>삭제</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    function addPlayer() {
      const name = document.getElementById('playerSelect').value;
      if (!name) return;

      selectedPlayers.push(name);

      renderPlayerSelect();
      renderPlayerTable();
      renderPositionSelects();
      renderStartingTable();
      renderWaitingTable();
      renderPositionAbility();
    }

    function removePlayer(name) {
      selectedPlayers = selectedPlayers.filter(n => n !== name);

      for (const pos in positionAssignments) {
        if (positionAssignments[pos] === name) {
          positionAssignments[pos] = '';
        }
      }

      startingList.forEach((row, i) => {
        if (row.name === name) {
          startingList[i] = { name: '', num: '', pos: '' };
        }
      });

      renderPlayerSelect();
      renderPlayerTable();
      renderPositionSelects();
      renderStartingTable();
      renderWaitingTable();
      renderPositionAbility();
    }

    function renderPositionSelects() {
      const selects = document.querySelectorAll('.posSelect');

      selects.forEach(sel => {
        const pos = sel.id.replace('pos_', '');

        sel.innerHTML = '';

        const blank = document.createElement('option');
        blank.value = '';
        blank.textContent = ' ';
        sel.appendChild(blank);

        selectedPlayers.forEach(name => {
          const opt = document.createElement('option');
          opt.value = name;
          opt.textContent = name;

          if (positionAssignments[pos] === name) opt.selected = true;

          sel.appendChild(opt);
        });
      });
    }

    function updatePosition(pos, playerName) {
      for (const key in positionAssignments) {
        if (positionAssignments[key] === playerName) {
          positionAssignments[key] = '';
        }
      }

      positionAssignments[pos] = playerName;

      startingList.forEach((row, i) => {
        if (!row.name) return;
        const stillAssigned = Object.values(positionAssignments).includes(row.name);
        if (!stillAssigned) {
          startingList[i] = { name: '', num: '', pos: '' };
        }
      });

      startingList.forEach((row, i) => {
        if (!row.name) return;

        const currentPosCode = Object.keys(positionAssignments)
          .find(key => positionAssignments[key] === row.name);

        if (currentPosCode) {
          row.pos = convertPosition(currentPosCode);
        } else {
          startingList[i] = { name: '', num: '', pos: '' };
        }
      });

      renderPositionSelects();
      renderStartingTable();
      renderWaitingTable();
      renderPositionAbility();
    }

    function getStartingCandidates() {
      return Object.values(positionAssignments).filter(v => v !== '');
    }

    function setupStartingTable() {
      const tbody = document.getElementById('startingTableBody');
      tbody.innerHTML = '';

      for (let i = 0; i < 10; i++) {
        const orderLabel = (i < 9) ? (i + 1) : '투수';

        const tr = document.createElement('tr');

        tr.innerHTML = `
          <td>${orderLabel}</td>

          <td>
            ${i === 9
            ? `<span id='start_name_${i}'></span>`
            : `<select id='start_sel_${i}' style='width:70px;' onchange='selectStarting(${i}, this.value)'></select>`
          }
          </td>

          <td id='start_num_${i}'></td>
          <td id='start_pos_${i}'></td>
        `;

        tbody.appendChild(tr);
      }
    }

    function renderStartingTable() {
      const candidates = getStartingCandidates();

      for (let i = 0; i < 10; i++) {

        if (i === 9) {
          const pName = positionAssignments['P'];
          const nameSpan = document.getElementById('start_name_' + i);

          if (pName) {
            const p = playerDB.find(x => x.name === pName);
            nameSpan.textContent = pName;
            document.getElementById('start_num_' + i).textContent = p.num;
            document.getElementById('start_pos_' + i).textContent = convertPosition('P');

            startingList[i] = {
              name: pName,
              num: p.num,
              pos: convertPosition('P')
            };

          } else {
            nameSpan.textContent = '';
            document.getElementById('start_num_' + i).textContent = '';
            document.getElementById('start_pos_' + i).textContent = '';
            startingList[i] = { name: '', num: '', pos: '' };
          }

          continue;
        }

        const sel = document.getElementById('start_sel_' + i);
        sel.innerHTML = '';

        const blank = document.createElement('option');
        blank.value = '';
        blank.textContent = ' ';
        sel.appendChild(blank);

        candidates.forEach(name => {
          const opt = document.createElement('option');
          opt.value = name;
          opt.textContent = name;
          if (startingList[i].name === name) opt.selected = true;
          sel.appendChild(opt);
        });

        const row = startingList[i];

        if (row.name) {
          const p = playerDB.find(x => x.name === row.name);
          document.getElementById('start_num_' + i).textContent = p.num;
          document.getElementById('start_pos_' + i).textContent = row.pos;
        } else {
          document.getElementById('start_num_' + i).textContent = '';
          document.getElementById('start_pos_' + i).textContent = '';
        }
      }
    }

    function selectStarting(idx, playerName) {
      startingList.forEach((row, i) => {
        if (i !== idx && row.name === playerName) {
          startingList[i] = { name: '', num: '', pos: '' };
        }
      });

      if (!playerName) {
        startingList[idx] = { name: '', num: '', pos: '' };
      } else {
        const p = playerDB.find(x => x.name === playerName);
        const posCode = Object.keys(positionAssignments)
          .find(key => positionAssignments[key] === playerName);

        startingList[idx] = {
          name: playerName,
          num: p.num,
          pos: convertPosition(posCode)
        };
      }

      renderStartingTable();
      renderWaitingTable();
      renderPositionAbility();
    }

    function convertPosition(code) {
      const map = {
        CF: '중견수(CF)',
        LF: '좌익수(LF)',
        RF: '우익수(RF)',
        SS: '유격수(SS)',
        '2B': '2루수(2B)',
        '3B': '3루수(3B)',
        '1B': '1루수(1B)',
        P: '투수(P)',
        C: '포수(C)',
        DH: '지명타자(DH)'
      };
      return map[code] || '';
    }

    function renderWaitingTable() {
      const tbody = document.getElementById('waitingTableBody');
      tbody.innerHTML = '';

      const starters = startingList
        .map(r => r.name)
        .filter(v => v);

      selectedPlayers
        .filter(name => !starters.includes(name))
        .sort((a, b) => a.localeCompare(b, 'ko'))
        .forEach(name => {

          const info = playerDB.find(x => x.name === name);
          const tr = document.createElement('tr');

          tr.innerHTML = `
            <td>${name}</td>
            <td>${info.num}</td>
          `;

          const hasPosition = Object.values(positionAssignments).includes(name);
          if (hasPosition) tr.classList.add('warningRow');

          tbody.appendChild(tr);
        });
    }

    function renderPositionAbility() {
  const container = document.getElementById('positionAbilityContainer');
  container.innerHTML = '';

  const table = document.createElement('table');

  const players = selectedPlayers.slice().sort((a, b) => a.localeCompare(b, 'ko'));

  abilityPositions.forEach(pos => {
    const starters = [];
    const backups = [];

    players.forEach(name => {
      const p = playerDB.find(x => x.name === name);
      const val = Number(p[pos.key]);
      if (val === 2) starters.push(name);
      else if (val === 1) backups.push(name);
    });

    starters.sort((a, b) => a.localeCompare(b, 'ko'));
    backups.sort((a, b) => a.localeCompare(b, 'ko'));

    // =====================================
    // 1) 선발 행
    // =====================================
    const trStarter = document.createElement('tr');

    // 1열: 포지션(rowspan=2)
    const tdPos = document.createElement('td');
    tdPos.textContent = pos.label;
    tdPos.rowSpan = 2;
    tdPos.style.background = '#bae4ff';   // ★ 요청 음영
    tdPos.style.fontWeight = 'bolder'
    trStarter.appendChild(tdPos);

    // 2열: '선발'
    const tdStarterLabel = document.createElement('td');
    tdStarterLabel.textContent = '선발';
    tdStarterLabel.style.background = '#bae4ff';  // ★ 요청 음영
      tdStarterLabel.style.fontWeight = 'bolder'
    trStarter.appendChild(tdStarterLabel);

    // 3열~ : 선발 선수들
    starters.forEach(name => {
      const td = document.createElement('td');
      td.textContent = name;

      const assignedPos = Object.keys(positionAssignments)
        .find(k => positionAssignments[k] === name);

      if (assignedPos) {
        if (isSamePosition(pos.key, assignedPos.toLowerCase())) {
          td.classList.add('position-selected');
        } else {
          td.classList.add('position-locked');
        }
      }

      trStarter.appendChild(td);
    });

    table.appendChild(trStarter);

    // =====================================
    // 2) 후보 행
    // =====================================
    const trBackup = document.createElement('tr');

    const tdBackupLabel = document.createElement('td');
    tdBackupLabel.textContent = '후보';
    tdBackupLabel.style.background = '#ffafaf';  // ★ 요청 음영
        tdBackupLabel.style.fontWeight = 'bolder'
    trBackup.appendChild(tdBackupLabel);

    backups.forEach(name => {
      const td = document.createElement('td');
      td.textContent = name;

      const assignedPos = Object.keys(positionAssignments)
        .find(k => positionAssignments[k] === name);

      if (assignedPos) {
        if (isSamePosition(pos.key, assignedPos.toLowerCase())) {
          td.classList.add('position-selected');
        } else {
          td.classList.add('position-locked');
        }
      }

      trBackup.appendChild(td);
    });

    table.appendChild(trBackup);
  });

  container.appendChild(table);
}




    function isSamePosition(posKey, assignedPos) {
      if (!assignedPos) return false;

      if (posKey === 'of') {
        return ['cf', 'lf', 'rf'].includes(assignedPos.toLowerCase());
      }

      return assignedPos.toLowerCase() === posKey;
    }

    function saveOrder() {
      const name = document.getElementById('orderName').value.trim();

      if (!name) {
        alert('오더명을 입력해주세요.');
        return;
      }

      const payload = {
        orderName: name,
        players: [...selectedPlayers],
        positions: { ...positionAssignments },
        startingList: [...startingList]
      };

      console.log('저장 예정 데이터:', payload);

      alert('저장 기능은 추후 구현됩니다!');
    }
  </script>

</body>
</html>
